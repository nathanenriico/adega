<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Adega do Tio Pancho</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="registro-container">
        <div class="registro-card">
            <div class="registro-header">
                <h1>üçª Bem-vindo √† Adega do Tio Pancho!</h1>
                <p>Para garantir uma entrega r√°pida e personalizada, precisamos de alguns dados:</p>
            </div>

            <form id="registro-form" class="registro-form">
                <div class="form-section">
                    <h3>‚úçÔ∏è Dados Pessoais</h3>
                    
                    <div class="form-field">
                        <label for="nome">Nome Completo *</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="form-field">
                        <label for="whatsapp">WhatsApp com DDD *</label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="(11) 99999-9999" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>üì¶ Endere√ßo de Entrega</h3>
                    
                    <div class="form-field">
                        <label for="cep">CEP *</label>
                        <input type="text" id="cep" name="cep" placeholder="12950-660" maxlength="9" required>
                    </div>

                    <div class="form-field">
                        <label for="rua">Rua (Logradouro) *</label>
                        <input type="text" id="rua" name="rua" placeholder="Rua das Margaridas" required>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="numero">N√∫mero *</label>
                            <input type="text" id="numero" name="numero" placeholder="375" required>
                        </div>
                        <div class="form-field">
                            <label for="complemento">Complemento</label>
                            <input type="text" id="complemento" name="complemento" placeholder="Casa">
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="bairro">Bairro *</label>
                        <input type="text" id="bairro" name="bairro" placeholder="Nova Atiaba" required>
                    </div>

                    <div class="form-field">
                        <label for="cidade">Cidade *</label>
                        <input type="text" id="cidade" name="cidade" value="Atibaia" required>
                    </div>
                </div>

                <button type="submit" class="submit-btn">Continuar para a Adega üç∑</button>
            </form>
            
            <div class="login-section">
                <p>J√° possui cadastro?</p>
                <button type="button" class="login-btn" onclick="showLoginForm()">Fazer Login üîë</button>
            </div>
            
            <div id="login-form" class="login-form" style="display: none;">
                <h3>üîë Login</h3>
                <div class="form-field">
                    <label for="login-whatsapp">WhatsApp</label>
                    <input type="tel" id="login-whatsapp" placeholder="(11) 99999-9999">
                </div>
                <button type="button" onclick="doLogin()" class="submit-btn">Entrar</button>
                <button type="button" onclick="hideLoginForm()" class="cancel-btn">Cancelar</button>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <p>Salvando seus dados...</p>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="login-error" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para salvar registro
        async function saveRegistro(event) {
            event.preventDefault();
            
            console.log('üöÄ Iniciando processo de cadastro...');
            
            const name = document.getElementById('nome').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            const cep = document.getElementById('cep').value.trim();
            const rua = document.getElementById('rua').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const complemento = document.getElementById('complemento').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            
            console.log('üìã Dados coletados:', { name, whatsapp, cep, rua, numero, complemento, bairro, cidade });
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // Validar campos obrigat√≥rios
            if (!name || !whatsapp || !cep || !rua || !numero || !bairro || !cidade) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Por favor, preencha todos os campos obrigat√≥rios!';
                return;
            }
            
            // Limpar e formatar WhatsApp
            const cleanWhatsapp = whatsapp.replace(/\D/g, '');
            
            // Validar WhatsApp (deve ter 10 ou 11 d√≠gitos)
            if (cleanWhatsapp.length < 10 || cleanWhatsapp.length > 11) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'N√∫mero de WhatsApp inv√°lido! Use formato: 11999887766';
                return;
            }
            
            // Garantir que tenha 11 d√≠gitos (adicionar 9 se necess√°rio)
            let formattedWhatsapp = cleanWhatsapp;
            if (cleanWhatsapp.length === 10 && !cleanWhatsapp.startsWith('9', 2)) {
                formattedWhatsapp = cleanWhatsapp.substring(0, 2) + '9' + cleanWhatsapp.substring(2);
            }
            
            try {
                console.log('üîÑ Verificando se usu√°rio j√° existe...');
                
                if (!window.supabase) {
                    throw new Error('Supabase n√£o carregado');
                }
                
                const client = window.supabase.createClient(
                    'https://vtrgtorablofhmhizrjr.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cmd0b3JhYmxvZmhtaGl6cmpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzI3OTQ3NSwiZXhwIjoyMDY4ODU1NDc1fQ.lq8BJEn9HVeyQl6SUCdVXgxdWsveDS07kQUhktko8B4'
                );
                
                // Verificar se usu√°rio j√° existe
                const { data: existingUser, error: checkError } = await client
                    .from('clientes')
                    .select('id, nome, whatsapp')
                    .eq('whatsapp', formattedWhatsapp)
                    .single();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('‚ùå Erro ao verificar usu√°rio:', checkError);
                    throw new Error('Erro ao verificar dados no banco');
                }
                
                if (existingUser) {
                    console.log('üë§ Usu√°rio j√° existe:', existingUser);
                    
                    // Salvar dados do usu√°rio existente localmente
                    const userData = { 
                        nome: existingUser.nome, 
                        whatsapp: existingUser.whatsapp
                    };
                    localStorage.setItem('userData', JSON.stringify(userData));
                    localStorage.setItem('userRegistered', 'true');
                    localStorage.setItem('userId', existingUser.id);
                    
                    document.getElementById('loading').style.display = 'none';
                    alert(`Bem-vindo de volta, ${existingUser.nome}! Voc√™ j√° possui cadastro.`);
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('üîÑ Criando novo usu√°rio...');
                
                const clienteData = {
                    nome: name,
                    whatsapp: formattedWhatsapp,
                    cep: cep,
                    rua: rua,
                    numero: numero,
                    complemento: complemento || null,
                    bairro: bairro,
                    cidade: cidade,
                    pontos: 50
                };
                
                console.log('üìù Inserindo novo cliente:', clienteData);
                
                const { data: clientData, error } = await client
                    .from('clientes')
                    .insert([clienteData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro no banco:', error);
                    
                    // Tratamento espec√≠fico para erro de duplicata
                    if (error.code === '23505' && error.message.includes('whatsapp')) {
                        throw new Error('Este n√∫mero de WhatsApp j√° est√° cadastrado. Tente fazer login.');
                    }
                    
                    throw new Error(`Falha ao salvar: ${error.message}`);
                }
                
                console.log('‚úÖ Cliente salvo no banco:', clientData);
                
                // Registrar pontos de b√¥nus no hist√≥rico
                try {
                    await client
                        .from('pontos_historico')
                        .insert({
                            cliente_id: clientData.id,
                            cliente_nome: name,
                            cliente_telefone: formattedWhatsapp,
                            cliente_endereco: `${rua}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade} - ${cep}`,
                            pontos: 50,
                            tipo: 'bonus',
                            descricao: 'B√¥nus de boas-vindas por criar conta'
                        });
                    console.log('üéÅ 50 pontos de b√¥nus adicionados!');
                } catch (pointsError) {
                    console.error('‚ö†Ô∏è Erro ao registrar pontos:', pointsError);
                }
                
                // Salvar localmente
                const userData = { 
                    nome: name, 
                    whatsapp: formattedWhatsapp,
                    endereco: `${rua}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade} - ${cep}`
                };
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('userRegistered', 'true');
                localStorage.setItem('userId', clientData.id);
                
                document.getElementById('loading').style.display = 'none';
                alert(`Cadastro realizado com sucesso!`);
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                
                // Mostrar mensagem de erro espec√≠fica
                if (error.message.includes('whatsapp')) {
                    document.getElementById('error-message').textContent = 'Este WhatsApp j√° est√° cadastrado. Voc√™ j√° possui uma conta!';
                } else if (error.message.includes('Supabase')) {
                    document.getElementById('error-message').textContent = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                } else {
                    document.getElementById('error-message').textContent = error.message || 'Erro ao processar cadastro. Tente novamente.';
                }
            }
        }
        
        // Fun√ß√µes de login
        function showLoginForm() {
            document.getElementById('registro-form').style.display = 'none';
            document.querySelector('.login-section').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }
        
        function hideLoginForm() {
            document.getElementById('registro-form').style.display = 'block';
            document.querySelector('.login-section').style.display = 'block';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('login-error').style.display = 'none';
        }
        
        async function doLogin() {
            const whatsapp = document.getElementById('login-whatsapp').value.trim();
            
            if (!whatsapp) {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-error').textContent = 'Digite seu WhatsApp!';
                return;
            }
            
            // Limpar e formatar WhatsApp
            const cleanWhatsapp = whatsapp.replace(/\D/g, '');
            let formattedWhatsapp = cleanWhatsapp;
            if (cleanWhatsapp.length === 10 && !cleanWhatsapp.startsWith('9', 2)) {
                formattedWhatsapp = cleanWhatsapp.substring(0, 2) + '9' + cleanWhatsapp.substring(2);
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('login-error').style.display = 'none';
            
            try {
                const client = window.supabase.createClient(
                    'https://vtrgtorablofhmhizrjr.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cmd0b3JhYmxvZmhtaGl6cmpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzI3OTQ3NSwiZXhwIjoyMDY4ODU1NDc1fQ.lq8BJEn9HVeyQl6SUCdVXgxdWsveDS07kQUhktko8B4'
                );
                
                const { data: user, error } = await client
                    .from('clientes')
                    .select('*')
                    .eq('whatsapp', formattedWhatsapp)
                    .single();
                
                if (error || !user) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('login-error').style.display = 'block';
                    document.getElementById('login-error').textContent = 'WhatsApp n√£o encontrado. Fa√ßa seu cadastro primeiro!';
                    return;
                }
                
                // Salvar dados localmente
                const userData = { 
                    nome: user.nome, 
                    whatsapp: user.whatsapp,
                    endereco: `${user.rua}, ${user.numero}${user.complemento ? ', ' + user.complemento : ''}, ${user.bairro}, ${user.cidade} - ${user.cep}`
                };
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('userRegistered', 'true');
                localStorage.setItem('userId', user.id);
                
                document.getElementById('loading').style.display = 'none';
                alert(`Bem-vindo de volta, ${user.nome}!`);
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Erro no login:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-error').textContent = 'Erro ao fazer login. Tente novamente.';
            }
        }
        
        // Adicionar event listener ao formul√°rio
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registro-form');
            if (form) {
                form.addEventListener('submit', saveRegistro);
            }
            
            // Enter no campo de login
            const loginWhatsapp = document.getElementById('login-whatsapp');
            if (loginWhatsapp) {
                loginWhatsapp.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        doLogin();
                    }
                });
            }
        });
        
        // Tornar fun√ß√µes globais
        window.showLoginForm = showLoginForm;
        window.hideLoginForm = hideLoginForm;
        window.doLogin = doLogin;
    </script>
</body>
</html>