<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Adega do Tio Pancho</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="registro-container">
        <div class="registro-card">
            <div class="registro-header">
                <h1>🍻 Bem-vindo à Adega do Tio Pancho!</h1>
                <p>Para garantir uma entrega rápida e personalizada, precisamos de alguns dados:</p>
            </div>

            <form id="registro-form" class="registro-form">
                <div class="form-section">
                    <h3>✍️ Dados Pessoais</h3>
                    
                    <div class="form-field">
                        <label for="nome">Nome Completo *</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>

                    <div class="form-field">
                        <label for="whatsapp">WhatsApp com DDD *</label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="(11) 99999-9999" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>📦 Endereço de Entrega</h3>
                    
                    <div class="form-field">
                        <label for="cep">CEP *</label>
                        <input type="text" id="cep" name="cep" placeholder="12950-660" maxlength="9" required>
                    </div>

                    <div class="form-field">
                        <label for="rua">Rua (Logradouro) *</label>
                        <input type="text" id="rua" name="rua" placeholder="Rua das Margaridas" required>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="numero">Número *</label>
                            <input type="text" id="numero" name="numero" placeholder="375" required>
                        </div>
                        <div class="form-field">
                            <label for="complemento">Complemento</label>
                            <input type="text" id="complemento" name="complemento" placeholder="Casa">
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="bairro">Bairro *</label>
                        <input type="text" id="bairro" name="bairro" placeholder="Nova Atiaba" required>
                    </div>

                    <div class="form-field">
                        <label for="cidade">Cidade *</label>
                        <input type="text" id="cidade" name="cidade" value="Atibaia" required>
                    </div>
                </div>

                <button type="submit" class="submit-btn">Continuar para a Adega 🍷</button>
            </form>

            <div id="loading" class="loading" style="display: none;">
                <p>Salvando seus dados...</p>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Função para salvar registro
        async function saveRegistro(event) {
            event.preventDefault();
            
            const name = document.getElementById('nome').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            const cep = document.getElementById('cep').value.trim();
            const rua = document.getElementById('rua').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const complemento = document.getElementById('complemento').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // Validar campos obrigatórios
            if (!name || !whatsapp || !cep || !rua || !numero || !bairro || !cidade) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Por favor, preencha todos os campos obrigatórios!';
                return;
            }
            
            // Validar WhatsApp
            const whatsappRegex = /^\(?\d{2}\)?[\s-]?9?\d{4}[\s-]?\d{4}$/;
            if (!whatsappRegex.test(whatsapp)) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Por favor, insira um número de WhatsApp válido!';
                return;
            }
            
            try {
                // Criar cliente Supabase
                const client = window.supabase.createClient(
                    'https://vtrgtorablofhmhizrjr.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cmd0b3JhYmxvZmhtaGl6cmpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzI3OTQ3NSwiZXhwIjoyMDY4ODU1NDc1fQ.lq8BJEn9HVeyQl6SUCdVXgxdWsveDS07kQUhktko8B4'
                );
                
                // Verificar se cliente já existe
                const { data: existingClient } = await client
                    .from('clientes')
                    .select('id, nome')
                    .eq('whatsapp', whatsapp)
                    .single();
                
                let clientData;
                
                if (existingClient) {
                    // Cliente já existe, usar dados existentes
                    clientData = existingClient;
                } else {
                    // Criar novo cliente
                    const { data, error } = await client
                        .from('clientes')
                        .insert({
                            nome: name,
                            whatsapp: whatsapp,
                            cep: cep,
                            rua: rua,
                            numero: numero,
                            complemento: complemento || null,
                            bairro: bairro,
                            cidade: cidade,
                            pontos: 0
                        })
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('Erro ao salvar no Supabase:', error);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('error-message').textContent = 'Erro ao salvar: ' + (error.message || 'WhatsApp já cadastrado');
                        return;
                    }
                    
                    clientData = data;
                }
                
                // Salvar localmente
                const userData = { 
                    nome: name, 
                    whatsapp: whatsapp,
                    endereco: `${rua}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade} - ${cep}`
                };
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('userRegistered', 'true');
                
                if (clientData && clientData.id) {
                    localStorage.setItem('userId', clientData.id);
                }
                
                // Redirecionar para página principal
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Erro ao salvar dados. Tente novamente.';
            }
        }
        
        // Adicionar event listener ao formulário
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registro-form');
            if (form) {
                form.addEventListener('submit', saveRegistro);
            }
        });
    </script>
</body>
</html>