<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Cadastro de Cliente</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-field {
            margin: 10px 0;
        }
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîß Debug - Cadastro de Cliente</h1>
        
        <form id="debug-form">
            <div class="form-field">
                <label for="nome">Nome Completo:</label>
                <input type="text" id="nome" value="Jo√£o Silva Teste">
            </div>
            
            <div class="form-field">
                <label for="whatsapp">WhatsApp:</label>
                <input type="text" id="whatsapp" value="11999887766">
            </div>
            
            <div class="form-field">
                <label for="cep">CEP:</label>
                <input type="text" id="cep" value="12950-000">
            </div>
            
            <div class="form-field">
                <label for="rua">Rua:</label>
                <input type="text" id="rua" value="Rua das Flores">
            </div>
            
            <div class="form-field">
                <label for="numero">N√∫mero:</label>
                <input type="text" id="numero" value="123">
            </div>
            
            <div class="form-field">
                <label for="complemento">Complemento:</label>
                <input type="text" id="complemento" value="Casa">
            </div>
            
            <div class="form-field">
                <label for="bairro">Bairro:</label>
                <input type="text" id="bairro" value="Centro">
            </div>
            
            <div class="form-field">
                <label for="cidade">Cidade:</label>
                <input type="text" id="cidade" value="Atibaia">
            </div>
            
            <button type="button" onclick="testCadastro()" class="btn-success">üß™ Testar Cadastro</button>
            <button type="button" onclick="generateRandomData()" class="btn-info">üé≤ Dados Aleat√≥rios</button>
            <button type="button" onclick="clearLog()" class="btn-danger">üßπ Limpar Log</button>
        </form>
    </div>
    
    <div class="debug-container">
        <h2>üìã Log de Debug</h2>
        <div id="debug-log" class="debug-log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vtrgtorablofhmhizrjr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cmd0b3JhYmxvZmhtaGl6cmpyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzI3OTQ3NSwiZXhwIjoyMDY4ODU1NDc1fQ.lq8BJEn9HVeyQl6SUCdVXgxdWsveDS07kQUhktko8B4';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }
        
        function generateRandomData() {
            const timestamp = Date.now().toString().slice(-6);
            document.getElementById('nome').value = `Cliente Teste ${timestamp}`;
            document.getElementById('whatsapp').value = `11999${timestamp}`;
            document.getElementById('cep').value = '12950-000';
            document.getElementById('rua').value = 'Rua de Teste';
            document.getElementById('numero').value = Math.floor(Math.random() * 999) + 1;
            document.getElementById('complemento').value = 'Teste';
            document.getElementById('bairro').value = 'Bairro Teste';
            document.getElementById('cidade').value = 'Atibaia';
            log('üé≤ Dados aleat√≥rios gerados', 'info');
        }
        
        async function testCadastro() {
            log('üöÄ Iniciando teste de cadastro...', 'info');
            
            // Coletar dados do formul√°rio
            const name = document.getElementById('nome').value.trim();
            const whatsapp = document.getElementById('whatsapp').value.trim();
            const cep = document.getElementById('cep').value.trim();
            const rua = document.getElementById('rua').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const complemento = document.getElementById('complemento').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            
            log(`üìã Dados coletados: Nome=${name}, WhatsApp=${whatsapp}`, 'info');
            
            // Validar campos obrigat√≥rios
            if (!name || !whatsapp || !cep || !rua || !numero || !bairro || !cidade) {
                log('‚ùå Campos obrigat√≥rios n√£o preenchidos', 'error');
                return;
            }
            
            // Validar WhatsApp
            const whatsappRegex = /^\\(?\\d{2}\\)?[\\s-]?9?\\d{4}[\\s-]?\\d{4}$/;
            if (!whatsappRegex.test(whatsapp)) {
                log('‚ùå Formato de WhatsApp inv√°lido', 'error');
                return;
            }
            
            try {
                // Verificar se Supabase est√° dispon√≠vel
                if (!window.supabase) {
                    log('‚ùå Supabase n√£o carregado', 'error');
                    return;
                }
                
                // Criar cliente Supabase
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úÖ Cliente Supabase criado', 'success');
                
                // Verificar se cliente j√° existe
                log('üîç Verificando se cliente j√° existe...', 'info');
                const { data: existingClient, error: checkError } = await client
                    .from('clientes')
                    .select('id, nome')
                    .eq('whatsapp', whatsapp)
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    log(`‚ùå Erro ao verificar cliente: ${checkError.message}`, 'error');
                    log(`üîç C√≥digo do erro: ${checkError.code}`, 'error');
                    return;
                }
                
                let clientData;
                
                if (existingClient) {
                    log(`‚úÖ Cliente j√° existe: ${existingClient.nome}`, 'warning');
                    clientData = existingClient;
                } else {
                    // Criar novo cliente
                    log('‚ûï Criando novo cliente...', 'info');
                    const clienteData = {
                        nome: name,
                        whatsapp: whatsapp,
                        cep: cep,
                        rua: rua,
                        numero: numero,
                        complemento: complemento || null,
                        bairro: bairro,
                        cidade: cidade,
                        pontos: 0
                    };
                    
                    log(`üìù Dados a serem inseridos: ${JSON.stringify(clienteData, null, 2)}`, 'info');
                    
                    const { data, error } = await client
                        .from('clientes')
                        .insert([clienteData])
                        .select()
                        .single();
                    
                    if (error) {
                        log(`‚ùå Erro ao salvar no Supabase: ${error.message}`, 'error');
                        log(`üîç C√≥digo: ${error.code}`, 'error');
                        log(`üîç Detalhes: ${JSON.stringify(error.details)}`, 'error');
                        log(`üîç Hint: ${error.hint}`, 'error');
                        return;
                    }
                    
                    log(`‚úÖ Cliente salvo com sucesso! ID: ${data.id}`, 'success');
                    clientData = data;
                }
                
                // Simular salvamento local
                const userData = { 
                    nome: name, 
                    whatsapp: whatsapp,
                    endereco: `${rua}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade} - ${cep}`
                };
                
                log('üíæ Simulando salvamento no localStorage...', 'info');
                log(`üìä Dados do usu√°rio: ${JSON.stringify(userData, null, 2)}`, 'info');
                
                if (clientData && clientData.id) {
                    log(`üÜî ID do cliente: ${clientData.id}`, 'success');
                }
                
                log('üéâ Teste de cadastro conclu√≠do com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
                log(`üìö Stack trace: ${error.stack}`, 'error');
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina de debug carregada', 'info');
            log('üìã Preencha os dados e clique em "Testar Cadastro"', 'info');
        });
    </script>
</body>
</html>