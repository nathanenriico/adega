<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando Pagamento - Adega do Tio Pancho</title>
    <link rel="stylesheet" href="css/checkout.css">
    <link rel="stylesheet" href="css/animations.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .processing-container {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .action-buttons {
            margin-top: 30px;
        }
        
        .action-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .primary-btn {
            background-color: #d4af37;
            color: white;
        }
        
        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Processando Pagamento</h1>
        </header>

        <main class="processing-container">
            <div id="processing">
                <div class="loader"></div>
                <h2>Verificando status do pagamento...</h2>
                <p>Por favor, aguarde enquanto processamos seu pagamento.</p>
            </div>
            
            <div id="success" class="status-message success" style="display: none;">
                <h2>Pagamento Confirmado! ‚úÖ</h2>
                <p>Seu pedido foi recebido e est√° sendo preparado.</p>
                <div class="order-details">
                    <p><strong>N√∫mero do pedido:</strong> <span id="order-id"></span></p>
                    <p><strong>Status:</strong> Confirmado</p>
                    <p><strong>Tempo estimado de entrega:</strong> 45-55 minutos</p>
                </div>
            </div>
            
            <div id="error" class="status-message error" style="display: none;">
                <h2>Pagamento n√£o conclu√≠do</h2>
                <p>Houve um problema ao processar seu pagamento.</p>
                <p>Voc√™ pode tentar novamente ou escolher outra forma de pagamento.</p>
            </div>
            
            <div id="pending" class="status-message pending" style="display: none;">
                <h2>Aguardando Comprovante PIX</h2>
                <p>Seu pedido foi recebido! Para prosseguir, envie o comprovante de pagamento PIX pelo WhatsApp.</p>
                <p><strong>Valor:</strong> R$ <span id="payment-amount"></span></p>
                <p><strong>Chave PIX:</strong> 11941716617 (Adega do Tio Pancho)</p>
                <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>‚ö†Ô∏è Importante:</strong> Ap√≥s fazer o PIX, envie o comprovante pelo WhatsApp para liberar seu pedido.
                </div>
            </div>
            
            <div class="action-buttons" id="action-buttons" style="display: none;">
                <button class="primary-btn" onclick="goToHome()">Voltar para a Loja</button>
                <button class="secondary-btn" onclick="goToWhatsApp()">Enviar Comprovante</button>
            </div>
        </main>
    </div>

    <script>
        // Fun√ß√£o para obter par√¢metros da URL
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            }
            
            return params;
        }
        
        // Fun√ß√£o para verificar status do pagamento
        function checkPaymentStatus() {
            const params = getUrlParams();
            const orderId = params.order_id || '';
            const status = params.status || '';
            const total = params.total || '0.00';
            const paymentMethod = params.payment || '';
            
            // Atualizar ID do pedido na tela
            document.getElementById('order-id').textContent = `#${orderId}`;
            
            // Atualizar valor do pagamento se for PIX
            const paymentAmountElement = document.getElementById('payment-amount');
            if (paymentAmountElement) {
                paymentAmountElement.textContent = total;
            }
            
            // Esconder loader
            document.getElementById('processing').style.display = 'none';
            
            // Mostrar bot√µes de a√ß√£o
            document.getElementById('action-buttons').style.display = 'block';
            
            // Para PIX, sempre mostrar status de aguardando comprovante
            if (paymentMethod === 'pix') {
                document.getElementById('pending').style.display = 'block';
                // N√£o atualizar status automaticamente - apenas na gest√£o manual
            } else {
                // Verificar status para outros m√©todos
                if (status === 'approved' || status === 'success' || status === 'completed') {
                    document.getElementById('success').style.display = 'block';
                    updateOrderStatus(orderId, 'approved');
                } else if (status === 'pending' || status === 'processing' || status === 'waiting') {
                    document.getElementById('pending').style.display = 'block';
                    updateOrderStatus(orderId, 'pending');
                } else {
                    document.getElementById('error').style.display = 'block';
                    updateOrderStatus(orderId, 'failed');
                }
            }
        }
        
        // Fun√ß√£o para atualizar status do pedido
        function updateOrderStatus(orderId, status) {
            try {
                const orders = JSON.parse(localStorage.getItem('adegaOrders') || '[]');
                const orderIndex = orders.findIndex(o => o.id == orderId);
                
                if (orderIndex !== -1) {
                    if (status === 'approved') {
                        orders[orderIndex].status = 'novo';
                        orders[orderIndex].paymentStatus = 'confirmado';
                        orders[orderIndex].paymentConfirmedAt = new Date().toISOString();
                    } else if (status === 'pending') {
                        orders[orderIndex].status = 'aguardando_pagamento';
                        orders[orderIndex].paymentStatus = 'pendente';
                    } else {
                        orders[orderIndex].status = 'cancelado';
                        orders[orderIndex].paymentStatus = 'falhou';
                    }
                    
                    orders[orderIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem('adegaOrders', JSON.stringify(orders));
                }
            } catch (error) {
                console.error('Erro ao atualizar status do pedido:', error);
            }
        }
        
        // Fun√ß√£o para voltar para a p√°gina inicial
        function goToHome() {
            window.location.href = 'index.html';
        }
        
        // Fun√ß√£o para abrir WhatsApp
        function goToWhatsApp() {
            const params = getUrlParams();
            const orderId = params.order_id || '';
            const total = params.total || '0.00';
            const paymentMethod = params.payment || '';
            
            let message;
            if (paymentMethod === 'pix') {
                message = encodeURIComponent(`üç∑ *Adega do Tio Pancho*\n\nOl√°! Acabei de fazer o pedido #${orderId} no valor de R$ ${total}.\n\nüí≥ Realizei o pagamento via PIX e estou enviando o comprovante.\n\nPor favor, confirme o recebimento para liberar meu pedido.\n\nObrigado!`);
            } else {
                message = encodeURIComponent(`üç∑ *Adega do Tio Pancho*\n\nOl√°! Acabei de fazer o pedido #${orderId}.\n\nGostaria de acompanhar o andamento pelo WhatsApp.\n\nObrigado!`);
            }
            
            // Detectar se √© mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Mobile: Abrir app WhatsApp
                window.open(`https://wa.me/5511941716617?text=${message}`, '_blank');
            } else {
                // Desktop: Abrir WhatsApp Web
                window.open(`https://web.whatsapp.com/send?phone=5511941716617&text=${message}`, '_blank');
            }
        }
        

        // Verificar status do pagamento quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', function() {
            // Simular um pequeno delay para mostrar o loader
            setTimeout(checkPaymentStatus, 1500);
        });
    </script>
</body>
</html>